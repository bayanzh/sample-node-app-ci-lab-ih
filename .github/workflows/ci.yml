name: Build, Test, and Deploy to Azure Container Apps

on:
workflow_dispatch:

permissions:
contents: read
id-token: write

jobs:
build-test-and-deploy:
runs-on: ubuntu-latest
environment: dev

```
steps:
  - name: Checkout code
    uses: actions/checkout@v4

  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: 22.x
      cache: npm
      cache-dependency-path: package-lock.json

  - name: Install dependencies
    run: npm ci

  - name: Run unit tests (if present)
    run: npm test --if-present

  - name: Build the application (optional)
    run: npm run build 2>/dev/null || echo "No build step; continuing."

  - name: Azure Login (OIDC)
    uses: azure/login@v2
    with:
      client-id: ${{ secrets.AZURE_CLIENT_ID }}
      tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  - name: Build, push image, and deploy to Azure Container Apps
    uses: azure/container-apps-deploy-action@v2
    with:
      appSourcePath: ${{ github.workspace }}
      registryUrl: docker.io
      registryUsername: ${{ secrets.DOCKERHUB_USERNAME }}
      registryPassword: ${{ secrets.DOCKERHUB_TOKEN }}
      resourceGroup: container-labs-rg
      containerAppName: frontendapp
      imageToBuild: ${{ secrets.DOCKERHUB_USERNAME }}/frontendapp-node:${{ github.sha }}
```
